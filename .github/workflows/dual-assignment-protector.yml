name: Dual Assignment Protector

# Trigger when an issue is manually assigned
on:
  issues:
    types: [assigned]

permissions:
  issues: write
  pull-requests: read # Needed to check for open PRs

jobs:
  enforce-one-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Check for existing assignments
        uses: actions/github-script@v7
        with:
          script: |
            const assignee = context.payload.assignee.login;
            const currentIssueNumber = context.payload.issue.number;
            const repo = context.repo;

            console.log(`Checking workload for @${assignee}...`);

            // 1. Fetch all OPEN issues assigned to this user
            const assignedIssues = await github.paginate(github.rest.issues.listForRepo, {
              ...repo,
              state: 'open',
              assignee: assignee
            });

            // 2. Filter out the current issue (since it was just assigned, it might be in the list)
            // We want to find *previous* or *other* issues.
            const otherIssues = assignedIssues.filter(i => i.number !== currentIssueNumber && !i.pull_request);

            // 3. Logic: Check if user has other issues
            if (otherIssues.length > 0) {
              
              // --- NEW: PR EXCEPTION CHECK ---
              // Search for OPEN PRs created by this user in this repo
              const { data: prSearch } = await github.rest.search.issuesAndPullRequests({
                q: `is:pr is:open author:${assignee} repo:${repo.owner}/${repo.repo}`
              });

              if (prSearch.total_count > 0) {
                console.log(`âœ… Exception granted: @${assignee} has ${prSearch.total_count} open PR(s).`);
                console.log("They are likely waiting for review. Assignment ALLOWED.");
                
                // Post a friendly note (Optional, remove if too noisy)
                await github.rest.issues.createComment({
                  ...repo,
                  issue_number: currentIssueNumber,
                  body: `â„¹ï¸ **Note:** @${assignee} has other open issues, but also has pending Pull Requests. Assignment is allowed.`
                });
                return; // STOP HERE - Do not block
              }
              // -------------------------------

              const issueLinks = otherIssues.map(i => `#${i.number}`).join(', ');
              console.log(`âš ï¸ Violation detected. User has ${otherIssues.length} other issues and NO open PRs.`);

              // A. Post a Warning Comment
              await github.rest.issues.createComment({
                ...repo,
                issue_number: currentIssueNumber,
                body: `ğŸš« **Assignment Blocked**
                
                @${assignee} is already assigned to **${otherIssues.length} other open issue(s)**: ${issueLinks} and has **no open Pull Requests**.
                
                **Policy:** You cannot take a new issue while holding others without submitting code.
                ğŸ‘‰ Please submit a PR for your current issue first.
                
                âš ï¸ **Action Taken:** The user has been automatically unassigned from this issue.`
              });

              // B. Revert the Assignment (Unassign the user)
              await github.rest.issues.removeAssignees({
                ...repo,
                issue_number: currentIssueNumber,
                assignees: [assignee]
              });
              
              console.log(`âœ… User unassigned from #${currentIssueNumber}`);
            } else {
              console.log("âœ… User is clear (0 other issues). Assignment allowed.");
            }
