name: Issue Auto Assignment

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: read # Needed to check for PRs

jobs:
  auto-assign:
    runs-on: ubuntu-latest
    steps:
      - name: Issue Assignment Guard
        uses: actions/github-script@v7
        with:
          script: |
            const commentBody = context.payload.comment.body.toLowerCase();
            const author = context.payload.comment.user.login;
            const issue = context.payload.issue;

            // =================================================================
            // 0. EXCLUSION LIST (Admin & Maintainers)
            // These users will NEVER be auto-assigned by comments.
            // They must be assigned manually via the sidebar.
            // =================================================================
            const maintainers = ["nem-web", "adi271001", "Suvam-paul145"]; 

            if (maintainers.includes(author)) {
              console.log(`User @${author} is a maintainer. Auto-assignment skipped.`);
              return; 
            }
            // =================================================================

            // 1. Ignore Bots and PR comments
            if (context.payload.comment.user.type === "Bot" || issue.pull_request) {
              return;
            }

            // 2. Define Keywords
            const intentWords = ["assign", "take", "work", "handle", "pick", "do", "fix", "solve"];
            const selfWords = ["me", "i", "myself"];

            // 3. Check if comment contains keywords
            const hasIntent = intentWords.some(w => commentBody.includes(w));
            const hasSelf = selfWords.some(w => commentBody.includes(w));

            if (!hasIntent || !hasSelf) {
              console.log("No assignment request detected.");
              return;
            }

            // 4. Check if issue is ALREADY assigned to ANYONE
            if (issue.assignees.length > 0) {
              return;
            }

            // 5. Check if the issue is "On Hold"
            const onHoldLabel = "on-hold"; 
            const isHold = issue.labels.some(label => label.name.toLowerCase() === onHoldLabel);

            if (isHold) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `â³ **Assignment Paused**
            
            @${author}, thanks for your interest!
            
            However, this issue is currently marked as **on-hold**.
            ðŸ‘‰ This usually means it depends on another task or requires further discussion.
            
            Please wait until the label is removed or check out other open issues.`
              });
              return;
            }

            // 6. STRICT CHECK: Does the user ALREADY have an open issue?
            const { data: assignedIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              assignee: author,
            });

            if (assignedIssues.length > 0) {
              
              // --- PR EXCEPTION CHECK ---
              // Search for OPEN PRs by this author in this repo
              const { data: prSearch } = await github.rest.search.issuesAndPullRequests({
                q: `is:pr is:open author:${author} repo:${context.repo.owner}/${context.repo.repo}`
              });

              if (prSearch.total_count > 0) {
                 // User has an open PR, so we ALLOW this new assignment.
                 console.log(`@${author} has open PRs. Granting exception.`);
                 
                 await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    body: `â„¹ï¸ **Multi-Tasking Exception**
                    
                    @${author} you have other open issues, but since you also have pending Pull Requests, this assignment is allowed.`
                 });
                 // We do NOT return here; we fall through to the assignment logic below.
              
              } else {
                 // User has issues but NO PRs -> BLOCK THEM
                 await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `ðŸ‘‹ @${author}
              
                  You already have an **assigned open issue** (#${assignedIssues[0].number}) and **no open Pull Requests**.
              
                  **Rule:** You can only work on **one issue at a time** unless you have submitted code (PR) for your previous task.
                  ðŸ‘‰ Please submit a PR for your current issue first.
              
                  Thanks for contributing ðŸš€`
                });
                return; // Stop execution
              }
            }

            // 7. Assign the issue
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              assignees: [author],
            });

            // 8. Post success comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `âœ… **Assigned to @${author}**
            
            All the best! ðŸš€  
            Feel free to ask questions or share progress updates here.`
            });
