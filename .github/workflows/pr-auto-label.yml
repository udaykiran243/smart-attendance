name: PR Auto Manager

# ðŸš€ CHANGE 1: Use 'pull_request_target' to allow writing labels on Fork PRs
on:
  pull_request_target:
    types: [opened, reopened, edited]

# ðŸš€ CHANGE 2: Grant 'issues: write' to allow adding labels/assignees
permissions:
  pull-requests: write
  issues: write

jobs:
  label-and-assign:
    runs-on: ubuntu-latest
    steps:
      - name: Assign User & Sync Labels
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const repo = context.repo;

            // -----------------------------------------
            // 1. Assign the PR to the creator
            // -----------------------------------------
            try {
              // Check if already assigned to avoid API spam
              if (pr.assignees.length === 0) {
                await github.rest.issues.addAssignees({
                  ...repo,
                  issue_number: pr.number,
                  assignees: [pr.user.login]
                });
                console.log(`âœ… Assigned PR to creator: ${pr.user.login}`);
              }
            } catch (error) {
              // Ignore error if user cannot be assigned (common with outside contributors)
              console.log(`âš ï¸ Could not assign user: ${error.message}`);
            }

            // -----------------------------------------
            // 2. Prepare Labels
            // -----------------------------------------
            // We ALWAYS add this label
            const labelsToAdd = ["apertre3.0"];

            // -----------------------------------------
            // 3. Find Linked Issue & Extract Difficulty
            // -----------------------------------------
            // Regex matches: "Closes #123", "Fixes #123"
            const linkedIssueRegex = /(?:close|closes|closed|fix|fixes|fixed|resolve|resolves|resolved):?\s+#(\d+)/i;
            const match = pr.body ? pr.body.match(linkedIssueRegex) : null;

            if (match) {
              const issueNumber = match[1];
              console.log(`ðŸ”Ž Found linked issue: #${issueNumber}`);

              try {
                // Fetch the linked issue's details
                const { data: issue } = await github.rest.issues.get({
                  ...repo,
                  issue_number: issueNumber
                });

                // Look for difficulty labels
                const difficultyKeywords = ["easy", "medium", "hard", "difficulty", "good first issue"];
                
                const foundLabels = issue.labels
                  .map(l => l.name)
                  .filter(name => difficultyKeywords.some(kw => name.toLowerCase().includes(kw)));

                if (foundLabels.length > 0) {
                  console.log(`ðŸŽ¯ Found difficulty labels: ${foundLabels.join(", ")}`);
                  labelsToAdd.push(...foundLabels);
                }

              } catch (error) {
                console.log(`âš ï¸ Error fetching issue #${issueNumber}: ${error.message}`);
              }
            }

            // -----------------------------------------
            // 4. Apply Labels to PR
            // -----------------------------------------
            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                ...repo,
                issue_number: pr.number,
                labels: labelsToAdd
              });
              console.log(`âœ… Applied labels: ${labelsToAdd.join(", ")}`);
            }
